name: Ethiopia FI Project CI

# Trigger on any push to main or pull request
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout Code
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. Set up Python 3.10 (Matching your local env)
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    # 3. Install Dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        # Install testing tools
        pip install pytest nbconvert ipykernel

    # 4. Task 1: Verify Data Injection (Script Check)
    - name: Run Task 1 (Enrichment)
      run: python src/task1_enrich.py

    # 5. Task 3: Verify Impact Modeling (Script Check)
    - name: Run Task 3 (Impact Engine)
      run: python src/task3_impact.py

    # 6. Task 4: Verify Forecast Notebook (Execution Check)
    # This runs the notebook from top to bottom. If any cell fails, CI fails.
    - name: Run Task 4 (Forecast Notebook)
      run: |
        jupyter nbconvert --to notebook --execute notebooks/Forecast_v1.ipynb --output notebooks/Forecast_v1_executed.ipynb

    # 7. Task 5: Verify Dashboard (Smoke Test)
    # We verify that the script compiles and can be called by Streamlit without syntax errors.
    # Note: We use 'timeout' to kill it after 10s because Streamlit runs forever.
    # If it crashes instantly, the exit code will be non-zero before timeout.
    - name: Run Task 5 (Dashboard Smoke Test)
      continue-on-error: true
      run: |
        timeout 10s streamlit run Dashboard/app.py --server.headless=true || code=$?; if [[ $code -ne 124 && $code -ne 0 ]]; then exit $code; fi